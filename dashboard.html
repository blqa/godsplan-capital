<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Godsplan | Core Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gp: {
                            bg: '#050505',
                            surface: '#121212',
                            border: '#262626',
                            text: '#FFFFFF',
                            muted: '#A1A1AA',
                            brand: '#3B82F6'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body { transition: background-color 0.3s ease, color 0.3s ease; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .view-section { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gp-bg dark:text-gp-text min-h-screen flex overflow-hidden">

    <!-- CORTINA DE SEGURIDAD -->
    <div id="security-curtain" class="fixed inset-0 z-[200] bg-white dark:bg-gp-bg flex flex-col items-center justify-center transition-colors">
        <i class="ph-bold ph-shield-check text-5xl text-blue-500 mb-4 animate-pulse"></i>
        <p class="font-mono text-gray-500 dark:text-gp-muted text-sm">Validando token de acceso...</p>
    </div>

    <!-- ALERTA DINÁMICA TOAST -->
    <div id="toast-alert" class="fixed top-20 md:top-8 right-4 md:right-8 bg-green-500 text-white px-6 py-3 rounded-xl shadow-2xl transform transition-all duration-300 translate-x-[150%] opacity-0 z-[150] flex items-center gap-3 font-medium">
        <i class="ph-bold ph-check-circle text-xl"></i>
        <span id="toast-message">Operación exitosa</span>
    </div>

    <!-- CABECERA MÓVIL -->
    <div class="md:hidden fixed top-0 w-full h-16 bg-white dark:bg-gp-surface border-b border-gray-200 dark:border-gp-border flex items-center justify-between px-4 z-[60] transition-colors">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-zinc-900 dark:bg-white text-white dark:text-zinc-900 rounded-lg flex items-center justify-center font-bold">G</div>
            <span class="font-bold text-lg tracking-tight text-gray-900 dark:text-white">Godsplan.</span>
        </div>
        <button id="mobile-menu-btn" class="text-gray-500 dark:text-gp-muted hover:text-gray-900 dark:hover:text-white focus:outline-none p-2 rounded-lg bg-gray-100 dark:bg-zinc-800">
            <i class="ph-bold ph-list text-xl"></i>
        </button>
    </div>

    <!-- BACKDROP PARA EL SIDEBAR EN MÓVIL -->
    <div id="sidebar-backdrop" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[70] hidden md:hidden transition-opacity"></div>

    <!-- SIDEBAR (LOS 4 PILARES) -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 w-64 h-full bg-white dark:bg-gp-surface border-r border-gray-200 dark:border-gp-border flex flex-col z-[80] transition-transform duration-300 ease-in-out">
        <div class="h-16 md:h-20 flex items-center justify-between px-6 border-b border-gray-200 dark:border-gp-border">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-zinc-900 dark:bg-white text-white dark:text-zinc-900 rounded-lg flex items-center justify-center font-bold">G</div>
                <span class="font-bold text-lg tracking-tight text-gray-900 dark:text-white">Godsplan.</span>
            </div>
            <button id="close-sidebar-btn" class="md:hidden text-gray-400 hover:text-white">
                <i class="ph-bold ph-x text-xl"></i>
            </button>
        </div>

        <nav class="flex-1 overflow-y-auto no-scrollbar py-6 px-4 space-y-2">
            <p class="px-3 text-[10px] font-bold text-gray-400 dark:text-zinc-600 uppercase tracking-widest mb-3">Core</p>
            
            <button data-target="view-dashboard" class="nav-link w-full flex items-center gap-3 px-3 py-3 rounded-xl bg-gray-100 dark:bg-zinc-800 text-blue-600 dark:text-white font-medium transition-colors">
                <i class="ph-fill ph-layout text-xl"></i> Dashboard
            </button>
            
            <button data-target="view-payments" class="nav-link w-full flex items-center gap-3 px-3 py-3 rounded-xl text-gray-500 dark:text-gp-muted hover:bg-gray-50 dark:hover:bg-zinc-800/50 hover:text-gray-900 dark:hover:text-white transition-colors">
                <i class="ph-fill ph-plus-circle text-xl"></i> Nueva Operación
            </button>
            
            <button data-target="view-history" class="nav-link w-full flex items-center gap-3 px-3 py-3 rounded-xl text-gray-500 dark:text-gp-muted hover:bg-gray-50 dark:hover:bg-zinc-800/50 hover:text-gray-900 dark:hover:text-white transition-colors">
                <i class="ph-fill ph-book-bookmark text-xl"></i> Libro Mayor
            </button>
            
            <p class="px-3 text-[10px] font-bold text-gray-400 dark:text-zinc-600 uppercase tracking-widest mt-8 mb-3">Administración</p>
            
            <button data-target="view-ecosystem" class="nav-link w-full flex items-center gap-3 px-3 py-3 rounded-xl text-gray-500 dark:text-gp-muted hover:bg-gray-50 dark:hover:bg-zinc-800/50 hover:text-gray-900 dark:hover:text-white transition-colors">
                <i class="ph-fill ph-cpu text-xl"></i> Ecosistema
            </button>
        </nav>

        <div class="p-4 border-t border-gray-200 dark:border-gp-border">
            <div class="mb-4 px-3 flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                <p class="text-xs text-gray-900 dark:text-white font-mono truncate" id="user-display">cargando...</p>
            </div>
            <button id="themeToggleBtn" class="w-full flex items-center justify-center gap-2 px-3 py-2 mb-2 rounded-xl text-gray-600 dark:text-gp-muted hover:bg-gray-100 dark:hover:bg-zinc-800 transition-colors">
                <i class="ph-bold ph-moon dark:hidden"></i>
                <i class="ph-bold ph-sun hidden dark:block"></i>
                <span class="text-sm font-medium">Tema Visual</span>
            </button>
            <button id="logout-btn" class="w-full flex items-center justify-center gap-2 px-3 py-2 rounded-xl text-red-500 hover:bg-red-50 dark:hover:bg-red-500/10 transition-colors">
                <i class="ph-bold ph-sign-out"></i>
                <span class="text-sm font-medium">Desconectar</span>
            </button>
        </div>
    </aside>

    <!-- MAIN APP AREA -->
    <main class="flex-1 w-full h-screen overflow-y-auto p-4 pt-20 md:p-8 md:pt-8 relative">

        <!-- ================================================================= -->
        <!-- VISTA 1: DASHBOARD (DIOS)                                         -->
        <!-- ================================================================= -->
        <section id="view-dashboard" class="view-section block max-w-6xl mx-auto">
            <header class="flex flex-col md:flex-row justify-between md:items-end gap-4 mb-6 md:mb-8">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white">Panorama General</h1>
                    <p class="text-gray-500 dark:text-gp-muted text-sm mt-1">El control absoluto de tu liquidez y deudas en un solo lugar.</p>
                </div>
                <button onclick="document.querySelector('[data-target=\'view-payments\']').click()" class="w-full md:w-auto bg-zinc-900 dark:bg-white text-white dark:text-zinc-900 px-5 py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg transition-transform active:scale-95 md:hover:scale-105">
                    <i class="ph-bold ph-plus"></i> Ingresar Registro
                </button>
            </header>

            <!-- ROW 1: Patrimonio & Presupuesto Diario -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 mb-6">
                <!-- Patrimonio -->
                <div class="bg-white dark:bg-gp-surface rounded-2xl md:rounded-3xl p-6 md:p-8 border border-gray-200 dark:border-gp-border shadow-sm flex flex-col justify-between">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-2 text-gray-500 dark:text-gp-muted font-bold text-xs uppercase tracking-wider">
                            <i class="ph-fill ph-scales"></i> Patrimonio Neto
                        </div>
                    </div>
                    <div>
                        <h2 class="text-4xl lg:text-5xl font-mono font-extrabold text-gray-900 dark:text-white tracking-tight" id="dash-patrimonio">$0.00</h2>
                        <p class="text-xs text-gray-500 dark:text-gp-muted mt-2">Activos - Pasivos</p>
                    </div>
                </div>

                <!-- Presupuesto Diario -->
                <div id="dash-daily-card" class="rounded-2xl md:rounded-3xl p-6 md:p-8 shadow-sm flex flex-col justify-between relative overflow-hidden bg-blue-600 text-white">
                    <div class="absolute -right-4 -bottom-4 opacity-20"><i class="ph-fill ph-calendar-check text-8xl"></i></div>
                    <div class="relative z-10" id="dash-daily-content">
                        <!-- JS Inject -->
                        <h3 class="text-xs font-bold text-blue-200 uppercase tracking-wider mb-2">Presupuesto Diario</h3>
                        <h2 class="text-4xl lg:text-5xl font-mono font-black tracking-tight">$0.00</h2>
                        <p class="text-xs text-blue-200 mt-2">Calculando liquidez...</p>
                    </div>
                </div>
            </div>

            <!-- ROW 2: Alertas Accionables (Pagos Fijos y TDC) -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 mb-6">
                
                <!-- WIDGET: Pagos Fijos Pendientes -->
                <div class="bg-white dark:bg-gp-surface rounded-2xl md:rounded-3xl p-6 md:p-8 border border-gray-200 dark:border-gp-border shadow-sm flex flex-col">
                    <div class="flex items-center gap-2 text-gray-900 dark:text-white font-bold mb-4">
                        <i class="ph-fill ph-calendar-blank text-blue-500 text-xl"></i>
                        <h3>Próximos Pagos Fijos</h3>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gp-muted mb-4">Retenidos antes de tu siguiente quincena.</p>
                    
                    <div id="dash-widget-fixed" class="space-y-3 flex-1 overflow-y-auto max-h-[250px] no-scrollbar">
                        <!-- JS Inject: Tarjetas minimalistas con Pagar/Omitir -->
                    </div>
                </div>

                <!-- WIDGET: Estado de Créditos -->
                <div class="bg-white dark:bg-gp-surface rounded-2xl md:rounded-3xl p-6 md:p-8 border border-gray-200 dark:border-gp-border shadow-sm flex flex-col">
                    <div class="flex items-center gap-2 text-gray-900 dark:text-white font-bold mb-4">
                        <i class="ph-fill ph-credit-card text-purple-500 text-xl"></i>
                        <h3>Estado de Créditos</h3>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gp-muted mb-4">Monto para no generar intereses y fechas límite.</p>
                    
                    <div id="dash-widget-tdc" class="space-y-3 flex-1 overflow-y-auto max-h-[250px] no-scrollbar">
                        <!-- JS Inject -->
                    </div>
                </div>
            </div>

            <!-- ROW 3: Flujo Rápido -->
            <div class="bg-white dark:bg-gp-surface rounded-2xl border border-gray-200 dark:border-gp-border p-4 shadow-sm flex justify-around text-center divide-x divide-gray-100 dark:divide-gp-border">
                <div class="flex-1">
                    <p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider mb-1">Entradas (Histórico)</p>
                    <p class="font-mono text-green-500 font-bold" id="dash-ingresos">$0.00</p>
                </div>
                <div class="flex-1">
                    <p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider mb-1">Salidas (Histórico)</p>
                    <p class="font-mono text-red-500 font-bold" id="dash-gastos">$0.00</p>
                </div>
            </div>
        </section>

        <!-- ================================================================= -->
        <!-- VISTA 2: NUEVA OPERACIÓN (/payments)                              -->
        <!-- ================================================================= -->
        <section id="view-payments" class="view-section hidden max-w-2xl mx-auto">
            <header class="mb-8 text-center md:mb-10">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white" id="tx-header-title">Nueva Operación</h1>
                <p class="text-gray-500 dark:text-gp-muted text-sm mt-1">Suma, resta o mueve fondos entre bóvedas</p>
            </header>

            <div class="bg-white dark:bg-gp-surface border border-gray-200 dark:border-gp-border rounded-2xl md:rounded-3xl p-5 md:p-8 shadow-xl relative">
                <button id="cancel-edit-btn" class="hidden absolute top-4 right-4 text-xs font-bold text-red-500 bg-red-50 dark:bg-red-500/10 px-3 py-1 rounded-lg hover:bg-red-100 dark:hover:bg-red-500/20 transition-colors">
                    <i class="ph-bold ph-x"></i> Cancelar
                </button>

                <form id="transaction-form" class="space-y-6">
                    <input type="hidden" id="tx-id-hidden" value="">
                    <input type="hidden" id="tx-fixed-id" value="">

                    <div class="flex gap-2 md:gap-4 p-1 bg-gray-100 dark:bg-gp-bg rounded-xl mb-6">
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="tx_type" id="tx_type_gasto" value="gasto" class="peer sr-only" checked>
                            <div class="text-center py-2 rounded-lg text-xs md:text-sm font-medium text-gray-500 peer-checked:bg-white peer-checked:dark:bg-gp-surface peer-checked:text-red-500 peer-checked:shadow-sm transition-all">Gasto</div>
                        </label>
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="tx_type" id="tx_type_ingreso" value="ingreso" class="peer sr-only">
                            <div class="text-center py-2 rounded-lg text-xs md:text-sm font-medium text-gray-500 peer-checked:bg-white peer-checked:dark:bg-gp-surface peer-checked:text-green-500 peer-checked:shadow-sm transition-all">Ingreso</div>
                        </label>
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="tx_type" id="tx_type_transferencia" value="transferencia" class="peer sr-only">
                            <div class="text-center py-2 rounded-lg text-xs md:text-sm font-medium text-gray-500 peer-checked:bg-white peer-checked:dark:bg-gp-surface peer-checked:text-blue-500 peer-checked:shadow-sm transition-all">Transferir</div>
                        </label>
                    </div>

                    <div class="text-center">
                        <label class="block text-[10px] md:text-xs font-bold text-gray-500 dark:text-gp-muted uppercase tracking-wider mb-2">Monto</label>
                        <div class="flex items-center justify-center text-4xl md:text-5xl font-mono font-bold text-gray-900 dark:text-white">
                            <span class="text-gray-400 dark:text-zinc-600 mr-1 md:mr-2">$</span>
                            <input type="number" id="tx-amount" step="0.01" required placeholder="0.00" class="bg-transparent w-full max-w-[200px] text-center focus:outline-none placeholder-gray-300 dark:placeholder-zinc-700">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 dark:text-gp-muted uppercase tracking-wider mb-2" id="lbl-cuenta-origen">Cuenta Afectada</label>
                            <select id="tx-account" required class="w-full bg-gray-50 dark:bg-gp-bg border border-gray-200 dark:border-gp-border rounded-xl px-4 py-3 text-sm text-gray-900 dark:text-white focus:outline-none focus:border-blue-500">
                                <option value="" disabled selected>Selecciona bóveda...</option>
                            </select>
                        </div>
                        
                        <div id="tx-category-container">
                            <label class="block text-xs font-bold text-gray-500 dark:text-gp-muted uppercase tracking-wider mb-2">Categoría</label>
                            <select id="tx-category" required class="w-full bg-gray-50 dark:bg-gp-bg border border-gray-200 dark:border-gp-border rounded-xl px-4 py-3 text-sm text-gray-900 dark:text-white focus:outline-none focus:border-blue-500">
                                <option value="General" selected>General</option>
                            </select>
                        </div>

                        <div id="tx-dest-container" class="hidden">
                            <label class="block text-xs font-bold text-gray-500 dark:text-gp-muted uppercase tracking-wider mb-2">Cuenta Destino</label>
                            <select id="tx-account-dest" class="w-full bg-gray-50 dark:bg-gp-bg border border-gray-200 dark:border-gp-border rounded-xl px-4 py-3 text-sm text-gray-900 dark:text-white focus:outline-none focus:border-blue-500">
                                <option value="" disabled selected>Hacia bóveda...</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 dark:text-gp-muted uppercase tracking-wider mb-2">Descripción</label>
                        <input type="text" id="tx-desc" required placeholder="Ej. Compra supermercado" class="w-full bg-gray-50 dark:bg-gp-bg border border-gray-200 dark:border-gp-border rounded-xl px-4 py-3 text-sm text-gray-900 dark:text-white focus:outline-none focus:border-blue-500">
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-center">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 dark:text-gp-muted uppercase tracking-wider mb-2">Fecha (Opcional)</label>
                            <input type="datetime-local" id="tx-date" class="w-full bg-gray-50 dark:bg-gp-bg border border-gray-200 dark:border-gp-border rounded-xl px-4 py-3 text-sm text-gray-900 dark:text-white focus:outline-none focus:border-blue-500">
                        </div>
                        <div class="flex items-center pt-2 sm:pt-6" id="tx-ignore-container">
                            <input type="checkbox" id="tx-ignore-daily" class="w-5 h-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:bg-zinc-800 dark:border-zinc-700">
                            <label for="tx-ignore-daily" class="ml-2 text-xs font-medium text-gray-500 dark:text-gp-muted cursor-pointer leading-tight">
                                Ignorar del presupuesto diario (Ej. Pago Fijo ya reservado)
                            </label>
                        </div>
                    </div>

                    <button type="submit" id="submit-tx-btn" class="w-full py-4 rounded-xl bg-zinc-900 text-white dark:bg-white dark:text-zinc-900 font-bold md:text-lg transition-transform active:scale-95 shadow-lg disabled:opacity-50">
                        Guardar Operación
                    </button>
                </form>
            </div>
        </section>

        <!-- ================================================================= -->
        <!-- VISTA 3: LIBRO MAYOR (/history)                                   -->
        <!-- ================================================================= -->
        <section id="view-history" class="view-section hidden max-w-6xl mx-auto">
            <header class="flex flex-col md:flex-row justify-between md:items-end gap-4 mb-8">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white">Libro Mayor</h1>
                    <p class="text-gray-500 dark:text-gp-muted text-sm mt-1">Registro inmutable de todas las transacciones</p>
                </div>
                <!-- Botón hacia Estados de Cuenta -->
                <a href="statements.html" class="w-full md:w-auto bg-gray-100 dark:bg-zinc-800 text-gray-900 dark:text-white px-5 py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-gray-200 dark:hover:bg-zinc-700 transition-colors">
                    <i class="ph-bold ph-file-pdf"></i> Generar Edo. Cuenta
                </a>
            </header>

            <div class="bg-white dark:bg-gp-surface border border-gray-200 dark:border-gp-border rounded-2xl shadow-sm overflow-hidden">
                <div class="overflow-x-auto w-full">
                    <table class="w-full text-left border-collapse min-w-[600px]">
                        <thead>
                            <tr class="bg-gray-50 dark:bg-zinc-900 border-b border-gray-200 dark:border-gp-border text-[10px] md:text-xs uppercase tracking-wider text-gray-500 dark:text-gp-muted whitespace-nowrap">
                                <th class="p-3 md:p-4 font-medium">Fecha</th>
                                <th class="p-3 md:p-4 font-medium">Descripción</th>
                                <th class="p-3 md:p-4 font-medium">Cuenta(s)</th>
                                <th class="p-3 md:p-4 font-medium">Tipo</th>
                                <th class="p-3 md:p-4 font-medium text-right">Monto</th>
                                <th class="p-3 md:p-4 font-medium text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body" class="divide-y divide-gray-100 dark:divide-gp-border text-xs md:text-sm">
                            <!-- JS Inject -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- ================================================================= -->
        <!-- VISTA 4: ECOSISTEMA (LA SALA DE MÁQUINAS)                         -->
        <!-- ================================================================= -->
        <section id="view-ecosystem" class="view-section hidden max-w-6xl mx-auto">
            <header class="mb-8">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white">Ecosistema</h1>
                <p class="text-gray-500 dark:text-gp-muted text-sm mt-1">Administración centralizada de tu entorno financiero. Configúralo una vez.</p>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <!-- 1. BÓVEDAS (CUENTAS ESPEJO) -->
                <div class="bg-white dark:bg-gp-surface border border-gray-200 dark:border-gp-border rounded-3xl p-6 shadow-sm flex flex-col">
                    <h3 class="font-bold text-lg text-gray-900 dark:text-white mb-4 flex items-center gap-2"><i class="ph-bold ph-vault text-blue-500"></i> Bóvedas Activas</h3>
                    <div id="eco-accounts-list" class="space-y-3 mb-6 max-h-48 overflow-y-auto no-scrollbar">
                        <!-- JS Inject List -->
                    </div>
                    <form id="eco-account-form" class="mt-auto border-t border-gray-100 dark:border-zinc-800 pt-4 space-y-3">
                        <p class="text-xs font-bold text-gray-500 uppercase tracking-wider">Crear Nueva Bóveda</p>
                        <div class="flex gap-2">
                            <input type="text" id="acc-name" required placeholder="Nombre" class="w-1/2 bg-gray-50 dark:bg-gp-bg border border-gray-200 dark:border-gp-border rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500">
                            <select id="acc-type" required class="w-1/2 bg-gray-50 dark:bg-gp-bg border border-gray-200 dark:border-gp-border rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500">
                                <option value="Débito">Débito</option>
                                <option value="Crédito">Crédito</option>
                                <option value="Efectivo">Efectivo</option>
                            </select>
                        </div>
                        <div class="flex gap-2">
                            <input type="number" id="acc-balance" step="0.01" required placeholder="Saldo inicial ($)" class="w-2/3 bg-gray-50 dark:bg-gp-bg border border-gray-200 dark:border-gp-border rounded-lg px-3 py-2 text-sm font-mono focus:outline-none focus:border-blue-500">
                            <button type="submit" id="submit-acc-btn" class="w-1/3 bg-zinc-900 text-white dark:bg-white dark:text-zinc-900 font-bold rounded-lg text-sm hover:scale-[1.02] transition-transform">Crear</button>
                        </div>
                    </form>
                </div>

                <!-- 2. ORGANIZADOR QUINCENA -->
                <div class="bg-white dark:bg-gp-surface border border-gray-200 dark:border-gp-border rounded-3xl p-6 shadow-sm flex flex-col">
                    <h3 class="font-bold text-lg text-gray-900 dark:text-white mb-4 flex items-center gap-2"><i class="ph-bold ph-calendar-check text-blue-500"></i> Ciclo de Ingresos</h3>
                    <p class="text-xs text-gray-500 mb-4 leading-relaxed">Configura los días en que recibes tu nómina o ingresos principales para calcular el Presupuesto Diario Seguro.</p>
                    <form id="eco-quincena-form" class="mt-auto space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1">Día 1</label>
                                <input type="number" id="q-day1" min="1" max="31" required placeholder="Ej. 15" class="w-full bg-gray-50 dark:bg-gp-bg border border-gray-200 dark:border-gp-border rounded-lg px-3 py-2 text-sm font-mono focus:outline-none focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1">Día 2 (Opcional)</label>
                                <input type="number" id="q-day2" min="1" max="31" placeholder="Ej. 30" class="w-full bg-gray-50 dark:bg-gp-bg border border-gray-200 dark:border-gp-border rounded-lg px-3 py-2 text-sm font-mono focus:outline-none focus:border-blue-500">
                            </div>
                        </div>
                        <button type="submit" id="submit-q-config-btn" class="w-full bg-zinc-900 text-white dark:bg-white dark:text-zinc-900 py-2.5 rounded-lg font-bold text-sm hover:scale-[1.02] transition-transform">Guardar Ciclo</button>
                    </form>
                </div>

                <!-- 3. PAGOS FIJOS -->
                <div class="bg-white dark:bg-gp-surface border border-gray-200 dark:border-gp-border rounded-3xl p-6 shadow-sm flex flex-col">
                    <h3 class="font-bold text-lg text-gray-900 dark:text-white mb-4 flex items-center gap-2"><i class="ph-bold ph-calendar-blank text-blue-500"></i> Pagos Fijos (Retenciones)</h3>
                    <div id="eco-fixed-list" class="space-y-3 mb-6 max-h-48 overflow-y-auto no-scrollbar">
                        <!-- JS Inject List -->
                    </div>
                    <form id="eco-fixed-form" class="mt-auto border-t border-gray-100 dark:border-zinc-800 pt-4 space-y-3">
                        <p class="text-xs font-bold text-gray-500 uppercase tracking-wider">Nuevo Pago Recurrente</p>
                        <input type="text" id="fixed-title" required placeholder="Concepto (Ej. Renta)" class="w-full bg-gray-50 dark:bg-gp-bg border border-gray-200 dark:border-gp-border rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500">
                        <div class="flex gap-2">
                            <input type="number" id="fixed-amount" step="0.01" required placeholder="Monto ($)" class="w-1/2 bg-gray-50 dark:bg-gp-bg border border-gray-200 dark:border-gp-border rounded-lg px-3 py-2 text-sm font-mono focus:outline-none focus:border-blue-500">
                            <input type="number" id="fixed-day" min="1" max="31" required placeholder="Día cobro" class="w-1/4 bg-gray-50 dark:bg-gp-bg border border-gray-200 dark:border-gp-border rounded-lg px-3 py-2 text-sm font-mono focus:outline-none focus:border-blue-500">
                            <button type="submit" id="submit-fixed-btn" class="w-1/4 bg-zinc-900 text-white dark:bg-white dark:text-zinc-900 font-bold rounded-lg text-sm hover:scale-[1.02] transition-transform">Crear</button>
                        </div>
                    </form>
                </div>

                <!-- 4. CONFIGURACIÓN TDC -->
                <div class="bg-white dark:bg-gp-surface border border-gray-200 dark:border-gp-border rounded-3xl p-6 shadow-sm flex flex-col">
                    <h3 class="font-bold text-lg text-gray-900 dark:text-white mb-4 flex items-center gap-2"><i class="ph-bold ph-credit-card text-blue-500"></i> Ciclos de Crédito</h3>
                    <p class="text-xs text-gray-500 mb-4 leading-relaxed">Selecciona una Bóveda de tipo 'Crédito' para asignarle fechas de corte y límites.</p>
                    <form id="eco-tdc-form" class="mt-auto space-y-3">
                        <select id="tdc-config-account" required class="w-full bg-gray-50 dark:bg-gp-bg border border-gray-200 dark:border-gp-border rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500">
                            <option value="" disabled selected>Selecciona tarjeta...</option>
                        </select>
                        <input type="number" id="tdc-config-limit" step="0.01" required placeholder="Límite de Crédito Total ($)" class="w-full bg-gray-50 dark:bg-gp-bg border border-gray-200 dark:border-gp-border rounded-lg px-3 py-2 text-sm font-mono focus:outline-none focus:border-blue-500">
                        <div class="flex gap-2">
                            <input type="number" id="tdc-config-cutoff" min="1" max="31" required placeholder="Día Corte" class="w-1/2 bg-gray-50 dark:bg-gp-bg border border-gray-200 dark:border-gp-border rounded-lg px-3 py-2 text-sm font-mono focus:outline-none focus:border-blue-500">
                            <input type="number" id="tdc-config-payment" min="1" max="31" required placeholder="Día Pago" class="w-1/2 bg-gray-50 dark:bg-gp-bg border border-gray-200 dark:border-gp-border rounded-lg px-3 py-2 text-sm font-mono focus:outline-none focus:border-blue-500">
                        </div>
                        <button type="submit" id="submit-tdc-config-btn" class="w-full bg-zinc-900 text-white dark:bg-white dark:text-zinc-900 py-2.5 rounded-lg font-bold text-sm hover:scale-[1.02] transition-transform">Guardar Configuración TDC</button>
                    </form>
                </div>

                <!-- 5. CATEGORÍAS -->
                <div class="bg-white dark:bg-gp-surface border border-gray-200 dark:border-gp-border rounded-3xl p-6 shadow-sm flex flex-col">
                    <h3 class="font-bold text-lg text-gray-900 dark:text-white mb-4 flex items-center gap-2"><i class="ph-bold ph-tag text-blue-500"></i> Categorías</h3>
                    <div id="eco-categories-list" class="flex flex-wrap gap-2 mb-6 max-h-32 overflow-y-auto no-scrollbar">
                        <!-- JS Inject -->
                    </div>
                    <form id="eco-category-form" class="mt-auto flex gap-2">
                        <input type="text" id="cat-name" required placeholder="Nueva etiqueta" class="flex-1 bg-gray-50 dark:bg-gp-bg border border-gray-200 dark:border-gp-border rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500">
                        <button type="submit" id="submit-cat-btn" class="bg-zinc-900 text-white dark:bg-white dark:text-zinc-900 px-4 font-bold rounded-lg text-sm hover:scale-[1.02] transition-transform">Añadir</button>
                    </form>
                </div>

                <!-- 6. DATA MIGRATION -->
                <div class="bg-gray-100 dark:bg-zinc-900/50 border border-gray-200 dark:border-gp-border rounded-3xl p-6 shadow-inner flex flex-col justify-center text-center">
                    <i class="ph-fill ph-database text-3xl text-gray-400 mb-2"></i>
                    <h3 class="font-bold text-lg text-gray-900 dark:text-white mb-1">Respaldo y Migración</h3>
                    <p class="text-xs text-gray-500 mb-6">Importa datos JSON de tu sistema antiguo o exporta a CSV.</p>
                    <div class="flex gap-2 justify-center">
                        <button id="export-csv-btn" class="bg-white dark:bg-zinc-800 border border-gray-200 dark:border-zinc-700 text-xs font-bold px-4 py-2 rounded-lg hover:border-blue-500 transition-colors shadow-sm">
                            Exportar CSV
                        </button>
                        <input type="file" id="import-json-input" accept=".json" class="hidden">
                        <button id="import-json-btn" class="bg-zinc-900 dark:bg-white text-white dark:text-zinc-900 text-xs font-bold px-4 py-2 rounded-lg shadow-sm">
                            Importar JSON
                        </button>
                    </div>
                </div>

            </div>
        </section>

    </main>

    <!-- ================================================================= -->
    <!-- LOGICA JAVASCRIPT: ESTADO GLOBAL Y FIREBASE CRUD                  -->
    <!-- ================================================================= -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, deleteDoc, doc, updateDoc, getDoc, writeBatch, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB9eeepHd1fcRBQbS17fyRWsO1ba734dbw",
            authDomain: "capital-gp.firebaseapp.com",
            projectId: "capital-gp",
            storageBucket: "capital-gp.firebasestorage.app",
            messagingSenderId: "14321430221",
            appId: "1:14321430221:web:7c827dc99b8d9446ae8384"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;

        let estadoApp = { cuentas: [], transacciones: [], categorias: [], pagosFijos: [], tdcConfig: [], quincenaConfig: null };
        window.cuentasConSaldosGlobal = [];
        window.patrimonioNetoTotalGlobal = 0;

        // UI Forms Toggle
        document.querySelectorAll('input[name="tx_type"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const isTransfer = e.target.value === 'transferencia';
                document.getElementById('tx-dest-container').classList.toggle('hidden', !isTransfer);
                document.getElementById('tx-category-container').classList.toggle('hidden', isTransfer);
                document.getElementById('tx-ignore-container').classList.toggle('hidden', isTransfer);
                document.getElementById('lbl-cuenta-origen').textContent = isTransfer ? 'Cuenta Origen' : 'Cuenta Afectada';
                document.getElementById('tx-account-dest').required = isTransfer;
                document.getElementById('tx-category').required = !isTransfer;
            });
        });

        // --- SEGURIDAD ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-display').textContent = user.email;
                document.getElementById('security-curtain').style.display = 'none';
                iniciarListenersBD();
            } else {
                window.location.href = 'auth.html';
            }
        });

        // --- LISTENERS ---
        function iniciarListenersBD() {
            onSnapshot(query(collection(db, `usuarios/${currentUser.uid}/categorias`), orderBy("nombre", "asc")), (s) => {
                estadoApp.categorias = []; s.forEach(d => estadoApp.categorias.push({ id: d.id, ...d.data() })); renderizarCategorias();
            });
            onSnapshot(query(collection(db, `usuarios/${currentUser.uid}/pagos_fijos`), orderBy("dia", "asc")), (s) => {
                estadoApp.pagosFijos = []; s.forEach(d => estadoApp.pagosFijos.push({ id: d.id, ...d.data() })); calcularQuincena(); renderizarPagosFijosEcosistema();
            });
            onSnapshot(query(collection(db, `usuarios/${currentUser.uid}/tdc_config`)), (s) => {
                estadoApp.tdcConfig = []; s.forEach(d => estadoApp.tdcConfig.push({ id: d.id, ...d.data() })); calcularDashboardTDC();
            });
            onSnapshot(doc(db, `usuarios/${currentUser.uid}/configuraciones`, 'quincena'), (d) => {
                if (d.exists()) {
                    estadoApp.quincenaConfig = d.data();
                    document.getElementById('q-day1').value = estadoApp.quincenaConfig.dia1 || '';
                    document.getElementById('q-day2').value = estadoApp.quincenaConfig.dia2 || '';
                }
                calcularQuincena();
            });
            onSnapshot(query(collection(db, `usuarios/${currentUser.uid}/cuentas`), orderBy("fecha_creacion", "asc")), (s) => {
                estadoApp.cuentas = []; s.forEach(d => estadoApp.cuentas.push({ id: d.id, ...d.data() })); calcularYRenderizar();
            });
            onSnapshot(query(collection(db, `usuarios/${currentUser.uid}/transacciones`), orderBy("fecha", "desc")), (s) => {
                estadoApp.transacciones = []; s.forEach(d => estadoApp.transacciones.push({ id: d.id, ...d.data() })); calcularYRenderizar();
            });
        }

        // --- CALCULO CENTRAL ---
        function calcularYRenderizar() {
            let patrimonioNetoTotal = 0; let totalIngresos = 0; let totalGastos = 0;
            let cuentasCalculadas = estadoApp.cuentas.map(c => ({ ...c, saldo_actual: c.saldo_inicial }));

            estadoApp.transacciones.forEach(tx => {
                let cuentaAfectada = cuentasCalculadas.find(c => c.nombre === tx.cuenta);
                if (tx.tipo === 'ingreso') { totalIngresos += tx.monto; if(cuentaAfectada) cuentaAfectada.saldo_actual += tx.monto; } 
                else if (tx.tipo === 'gasto') { totalGastos += tx.monto; if(cuentaAfectada) cuentaAfectada.saldo_actual -= tx.monto; }
                else if (tx.tipo === 'ajuste') { if(cuentaAfectada) cuentaAfectada.saldo_actual += tx.monto; }
                else if (tx.tipo === 'transferencia') {
                    let cuentaDestino = cuentasCalculadas.find(c => c.nombre === tx.cuenta_destino);
                    if(cuentaAfectada) cuentaAfectada.saldo_actual -= tx.monto;
                    if(cuentaDestino) cuentaDestino.saldo_actual += tx.monto;
                }
            });

            patrimonioNetoTotal = cuentasCalculadas.reduce((sum, c) => sum + c.saldo_actual, 0);
            window.cuentasConSaldosGlobal = cuentasCalculadas;
            window.patrimonioNetoTotalGlobal = patrimonioNetoTotal; 

            document.getElementById('dash-patrimonio').innerHTML = `$${patrimonioNetoTotal.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('dash-ingresos').textContent = `$${totalIngresos.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('dash-gastos').textContent = `$${totalGastos.toLocaleString('en-US', {minimumFractionDigits: 2})}`;

            renderizarCuentasEcosistema();
            renderizarHistorial();
            calcularDashboardTDC();
            calcularQuincena();
        }

        // --- DASHBOARD WIDGETS ---
        function calcularQuincena() {
            const config = estadoApp.quincenaConfig;
            const contentDash = document.getElementById('dash-daily-content');
            const cardDash = document.getElementById('dash-daily-card');
            const dashFixedWidget = document.getElementById('dash-widget-fixed');

            if (!config || (!config.dia1 && !config.dia2)) {
                cardDash.className = "rounded-2xl md:rounded-3xl p-6 md:p-8 shadow-sm flex flex-col justify-between relative overflow-hidden bg-blue-600 text-white cursor-pointer";
                contentDash.innerHTML = `<h3 class="text-xs font-bold text-blue-200 uppercase tracking-wider mb-2">Presupuesto Diario</h3><h2 class="text-4xl lg:text-5xl font-mono font-black tracking-tight my-2">$0.00</h2><p class="text-xs text-blue-200 mt-2">Ve a Ecosistema > Ciclo de Ingresos</p>`;
                dashFixedWidget.innerHTML = '<p class="text-sm text-gray-500">Configura tu quincena primero.</p>';
                return;
            }

            const hoy = new Date(); const hoySoloFecha = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());
            const hoyStr = hoy.toLocaleDateString('es-MX'); const currentYYYYMM = `${hoy.getFullYear()}-${String(hoy.getMonth()+1).padStart(2, '0')}`;

            let diasPago = [];
            if (config.dia1) diasPago.push(parseInt(config.dia1));
            if (config.dia2) diasPago.push(parseInt(config.dia2));
            diasPago.sort((a, b) => a - b);

            let nextPayday = null; let currentMonth = hoy.getMonth(); let currentYear = hoy.getFullYear();

            for (let dia of diasPago) {
                let lastDayOfMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
                let possibleDate = new Date(currentYear, currentMonth, Math.min(dia, lastDayOfMonth));
                if (possibleDate > hoySoloFecha) { nextPayday = possibleDate; break; }
            }

            if (!nextPayday) {
                currentMonth++; if (currentMonth > 11) { currentMonth = 0; currentYear++; }
                let lastDayOfMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
                nextPayday = new Date(currentYear, currentMonth, Math.min(diasPago[0], lastDayOfMonth));
            }

            const msPerDay = 1000 * 60 * 60 * 24;
            let daysLeft = Math.ceil((nextPayday - hoySoloFecha) / msPerDay);
            if (daysLeft === 0) daysLeft = 1;

            let pagosFijosPendientesTotal = 0; let pagosFijosList = [];
            for(let i=1; i<=daysLeft; i++) {
                let checkDate = new Date(hoySoloFecha.getTime() + (i * msPerDay));
                let checkDay = checkDate.getDate();
                estadoApp.pagosFijos.forEach(pf => {
                    let lastDay = new Date(checkDate.getFullYear(), checkDate.getMonth() + 1, 0).getDate();
                    if (Math.min(parseInt(pf.dia), lastDay) === checkDay && pf.ultimo_pago !== `${checkDate.getFullYear()}-${String(checkDate.getMonth()+1).padStart(2, '0')}`) { 
                        pagosFijosPendientesTotal += pf.monto; pagosFijosList.push(pf); 
                    }
                });
            }

            let gastosHoy = 0;
            estadoApp.transacciones.forEach(tx => {
                if(tx.tipo === 'gasto' && !tx.ignoreDaily && tx.fecha && tx.fecha.toDate().toLocaleDateString('es-MX') === hoyStr) gastosHoy += tx.monto;
            });

            let liquidezActual = window.cuentasConSaldosGlobal.filter(c => c.tipo !== 'Crédito').reduce((s, c) => s + c.saldo_actual, 0);
            let dineroLibreActual = liquidezActual - pagosFijosPendientesTotal;
            let presupuestoBaseHoy = (dineroLibreActual + gastosHoy) / daysLeft;
            let restanteHoy = presupuestoBaseHoy - gastosHoy;

            // Renderizar Tarjeta Principal
            if (restanteHoy >= 0) {
                cardDash.className = "rounded-2xl md:rounded-3xl p-6 md:p-8 shadow-sm flex flex-col justify-between relative overflow-hidden bg-blue-600 text-white cursor-pointer hover:bg-blue-700 transition-colors";
                contentDash.innerHTML = `<h3 class="text-xs font-bold text-blue-200 uppercase tracking-wider mb-2">Libres Para Hoy</h3><h2 class="text-4xl lg:text-5xl font-mono font-black tracking-tight my-2">$${restanteHoy.toLocaleString('en-US', {minimumFractionDigits: 2})}</h2><p class="text-[10px] text-blue-200 mt-2">Límite base: $${presupuestoBaseHoy.toLocaleString('en-US', {minimumFractionDigits: 2})} | Gastado: $${gastosHoy.toLocaleString('en-US', {minimumFractionDigits: 2})}</p><p class="text-[10px] text-blue-300 font-mono mt-1">${daysLeft} días para quincena</p>`;
            } else {
                cardDash.className = "rounded-2xl md:rounded-3xl p-6 md:p-8 shadow-sm flex flex-col justify-between relative overflow-hidden bg-red-600 text-white cursor-pointer hover:bg-red-700 transition-colors";
                let presupuestoFuturo = daysLeft > 1 ? (dineroLibreActual / (daysLeft - 1)) : 0;
                contentDash.innerHTML = `<h3 class="text-xs font-bold text-red-200 uppercase tracking-wider mb-2">Presupuesto Excedido</h3><h2 class="text-4xl lg:text-5xl font-mono font-black tracking-tight my-2 text-red-100">-$${Math.abs(restanteHoy).toLocaleString('en-US', {minimumFractionDigits: 2})}</h2><p class="text-[10px] text-red-100 mt-2">Límite era: $${presupuestoBaseHoy.toLocaleString('en-US', {minimumFractionDigits: 2})} | Gastado: $${gastosHoy.toLocaleString('en-US', {minimumFractionDigits: 2})}</p><p class="text-[10px] text-red-200 font-mono font-bold mt-1">Límite mañana: $${presupuestoFuturo.toLocaleString('en-US', {minimumFractionDigits: 2})}</p>`;
            }

            // Renderizar Widget Pagos Fijos en Dashboard
            dashFixedWidget.innerHTML = '';
            if (pagosFijosList.length === 0) {
                dashFixedWidget.innerHTML = `<div class="p-4 bg-green-50 dark:bg-green-500/10 text-green-600 rounded-xl border border-green-100 dark:border-green-500/20 text-sm font-medium text-center"><i class="ph-bold ph-check-circle text-lg mb-1 block"></i> Todo al día. Nada retenido.</div>`;
            } else {
                pagosFijosList.forEach(pf => {
                    dashFixedWidget.insertAdjacentHTML('beforeend', `
                        <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gp-bg rounded-xl border border-gray-100 dark:border-zinc-800">
                            <div>
                                <p class="font-bold text-sm text-gray-900 dark:text-white">${pf.titulo}</p>
                                <p class="text-xs text-red-500 font-mono">-$${pf.monto.toLocaleString('en-US', {minimumFractionDigits: 2})} <span class="text-gray-400">| Día ${pf.dia}</span></p>
                            </div>
                            <div class="flex gap-1">
                                <button onclick="window.prepararPagoFijo('${pf.id}')" class="px-2 py-1 bg-zinc-900 dark:bg-white text-white dark:text-zinc-900 text-xs font-bold rounded hover:scale-105 transition-transform shadow-sm">Pagar</button>
                                <button onclick="window.omitirPagoFijo('${pf.id}')" class="px-2 py-1 bg-gray-200 dark:bg-zinc-700 text-gray-600 dark:text-gray-300 text-xs font-bold rounded hover:bg-gray-300 dark:hover:bg-zinc-600 transition-colors" title="Omitir este mes"><i class="ph-bold ph-x"></i></button>
                            </div>
                        </div>
                    `);
                });
            }
        }

        function calcularDashboardTDC() {
            const dashTDCWidget = document.getElementById('dash-widget-tdc');
            const selectConfig = document.getElementById('tdc-config-account');
            dashTDCWidget.innerHTML = ''; selectConfig.innerHTML = '<option value="" disabled selected>Selecciona tarjeta...</option>';

            const tarjetasCredito = window.cuentasConSaldosGlobal.filter(c => c.tipo === 'Crédito');
            if(tarjetasCredito.length === 0) { dashTDCWidget.innerHTML = '<p class="text-sm text-gray-500">No tienes cuentas de Crédito.</p>'; return; }

            const hoy = new Date(); const diaActual = hoy.getDate(); const mesActual = hoy.getMonth(); const anioActual = hoy.getFullYear();

            tarjetasCredito.forEach(acc => {
                selectConfig.insertAdjacentHTML('beforeend', `<option value="${acc.nombre}">${acc.nombre}</option>`);
                const config = estadoApp.tdcConfig.find(c => c.cuenta === acc.nombre);
                
                if(!config) {
                    dashTDCWidget.insertAdjacentHTML('beforeend', `<div class="p-3 border border-dashed border-gray-300 dark:border-zinc-700 rounded-xl text-center"><p class="text-sm font-bold text-gray-900 dark:text-white">${acc.nombre}</p><p class="text-xs text-gray-500">Falta configurar en Ecosistema</p></div>`); return;
                }

                const diaCorte = parseInt(config.dia_corte); const diaPago = parseInt(config.dia_pago);
                let fechaUltimoCorte = new Date(anioActual, mesActual, diaCorte, 23, 59, 59);
                if (diaActual < diaCorte) fechaUltimoCorte.setMonth(fechaUltimoCorte.getMonth() - 1);
                let fechaLimitePago = new Date(fechaUltimoCorte); fechaLimitePago.setDate(diaPago);
                if (fechaLimitePago <= fechaUltimoCorte) fechaLimitePago.setMonth(fechaLimitePago.getMonth() + 1);

                let gastosTransito = 0;
                estadoApp.transacciones.forEach(tx => {
                    if (tx.cuenta === acc.nombre && tx.tipo === 'gasto') {
                        const txDate = tx.fecha ? tx.fecha.toDate() : new Date();
                        if (txDate > fechaUltimoCorte) gastosTransito += tx.monto;
                    }
                });

                const deudaTotal = acc.saldo_actual < 0 ? Math.abs(acc.saldo_actual) : 0;
                const pagoNoIntereses = Math.max(0, deudaTotal - gastosTransito);
                const strPago = fechaLimitePago.toLocaleDateString('es-MX', { day: '2-digit', month: 'short' });
                const diffDays = Math.ceil((fechaLimitePago - hoy) / (1000 * 60 * 60 * 24));
                
                let colorAlerta = 'text-gray-500'; let msjAlerta = `Límite: ${strPago}`;
                if (diffDays <= 5 && diffDays >= 0 && pagoNoIntereses > 0) { colorAlerta = 'text-orange-500 font-bold'; msjAlerta = `Paga en ${diffDays} días`; } 
                else if (diffDays < 0 && pagoNoIntereses > 0) { colorAlerta = 'text-red-500 font-bold'; msjAlerta = `Vencido`; }
                else if (pagoNoIntereses === 0) { colorAlerta = 'text-green-500 font-bold'; msjAlerta = `Pagado`; }

                dashTDCWidget.insertAdjacentHTML('beforeend', `
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gp-bg rounded-xl border border-gray-100 dark:border-zinc-800">
                        <div>
                            <p class="font-bold text-sm text-gray-900 dark:text-white">${acc.nombre}</p>
                            <p class="text-[10px] ${colorAlerta}">${msjAlerta}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-mono font-black ${pagoNoIntereses > 0 ? 'text-red-500' : 'text-green-500'}">$${pagoNoIntereses.toLocaleString('en-US', {minimumFractionDigits: 2})}</p>
                            <p class="text-[10px] text-gray-400 font-mono border-t border-gray-200 dark:border-zinc-700 mt-1 pt-1">Total Deuda: $${deudaTotal.toLocaleString()}</p>
                        </div>
                    </div>
                `);
            });
        }

        // --- RENDERIZADO ECOSISTEMA Y HISTORIAL ---
        function renderizarCuentasEcosistema() {
            const ecoAccountsList = document.getElementById('eco-accounts-list');
            const txAccountSelect = document.getElementById('tx-account');
            const txAccountDestSelect = document.getElementById('tx-account-dest');
            
            ecoAccountsList.innerHTML = '';
            txAccountSelect.innerHTML = '<option value="" disabled selected>Selecciona bóveda...</option>';
            txAccountDestSelect.innerHTML = '<option value="" disabled selected>Hacia bóveda...</option>';

            window.cuentasConSaldosGlobal.forEach(acc => {
                ecoAccountsList.insertAdjacentHTML('beforeend', `
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gp-bg rounded-xl border border-gray-100 dark:border-zinc-800 group">
                        <div>
                            <p class="font-bold text-sm text-gray-900 dark:text-white">${acc.nombre} <span class="text-[10px] font-normal text-gray-500 ml-1">(${acc.tipo})</span></p>
                            <p class="font-mono text-xs ${acc.saldo_actual < 0 ? 'text-red-500' : 'text-blue-500'} font-bold mt-0.5">$${acc.saldo_actual.toLocaleString()}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="window.ajustarCuenta('${acc.id}', ${acc.saldo_actual}, '${acc.nombre}')" class="text-gray-400 hover:text-blue-500 opacity-0 group-hover:opacity-100 transition-opacity" title="Ajustar Real"><i class="ph-bold ph-sliders"></i></button>
                            <button onclick="window.borrarCuenta('${acc.id}')" class="text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><i class="ph-bold ph-trash"></i></button>
                        </div>
                    </div>
                `);
                txAccountSelect.insertAdjacentHTML('beforeend', `<option value="${acc.nombre}">${acc.nombre} ($${acc.saldo_actual.toFixed(2)})</option>`);
                txAccountDestSelect.insertAdjacentHTML('beforeend', `<option value="${acc.nombre}">${acc.nombre} ($${acc.saldo_actual.toFixed(2)})</option>`);
            });
        }

        function renderizarHistorial() {
            const tbody = document.getElementById('history-table-body'); tbody.innerHTML = '';
            estadoApp.transacciones.forEach(tx => {
                let fechaStr = "Procesando..."; if(tx.fecha) fechaStr = tx.fecha.toDate().toLocaleDateString('es-MX', { day: '2-digit', month: 'short', hour: '2-digit', minute:'2-digit' });
                let colorMonto = 'text-gray-500'; let signo = ''; let montoMostrado = Math.abs(tx.monto).toFixed(2);
                let cuentaAfectadaHTML = `<td class="p-3 md:p-4 text-gray-500 dark:text-gp-muted truncate max-w-[100px] sm:max-w-none">${tx.cuenta}</td>`;
                
                if (tx.tipo === 'ingreso') { colorMonto = 'text-green-500'; signo = '+'; } 
                else if (tx.tipo === 'gasto') { colorMonto = 'text-red-500'; signo = '-'; } 
                else if (tx.tipo === 'ajuste') { colorMonto = 'text-blue-500'; signo = tx.monto >= 0 ? '+' : '-'; }
                else if (tx.tipo === 'transferencia') { 
                    colorMonto = 'text-blue-500'; 
                    cuentaAfectadaHTML = `<td class="p-3 md:p-4 text-gray-500 dark:text-gp-muted text-[10px] sm:text-xs font-mono">${tx.cuenta} <i class="ph-bold ph-arrow-right mx-1 text-blue-500"></i> ${tx.cuenta_destino}</td>`;
                }
                
                let ignoreBadge = tx.ignoreDaily ? '<span class="text-[8px] bg-red-100 text-red-600 dark:bg-red-500/20 dark:text-red-400 px-1 rounded ml-1" title="Ignorado del presupuesto">IGN</span>' : '';

                tbody.insertAdjacentHTML('beforeend', `
                    <tr class="hover:bg-gray-50 dark:hover:bg-zinc-800/50 transition-colors">
                        <td class="p-3 md:p-4 text-gray-500 dark:text-gp-muted font-mono whitespace-nowrap">${fechaStr}</td>
                        <td class="p-3 md:p-4 font-medium text-gray-900 dark:text-white"><span class="truncate block max-w-[120px] sm:max-w-none">${tx.descripcion} ${ignoreBadge}</span><span class="text-[10px] text-gray-400 font-normal uppercase tracking-wider block mt-0.5">#${tx.categoria}</span></td>
                        ${cuentaAfectadaHTML}
                        <td class="p-3 md:p-4 text-[10px] md:text-xs uppercase font-bold text-gray-500">${tx.tipo}</td>
                        <td class="p-3 md:p-4 text-right font-mono font-bold ${colorMonto}">${signo}$${montoMostrado}</td>
                        <td class="p-3 md:p-4 text-center whitespace-nowrap"><button onclick="window.editarTx('${tx.id}')" class="text-blue-500 hover:text-blue-400 mr-2 md:mr-3 p-1"><i class="ph-bold ph-pencil text-lg"></i></button><button onclick="window.borrarTx('${tx.id}')" class="text-red-500 hover:text-red-400 p-1"><i class="ph-bold ph-trash text-lg"></i></button></td>
                    </tr>
                `);
            });
        }

        function renderizarPagosFijosEcosistema() {
            const list = document.getElementById('eco-fixed-list'); list.innerHTML = '';
            estadoApp.pagosFijos.forEach(pf => {
                list.insertAdjacentHTML('beforeend', `
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gp-bg rounded-xl border border-gray-100 dark:border-zinc-800 group">
                        <div class="flex items-center gap-3">
                            <span class="w-8 h-8 rounded-lg bg-blue-500/10 text-blue-500 flex items-center justify-center font-mono font-bold text-xs">${pf.dia}</span>
                            <div>
                                <p class="font-bold text-sm text-gray-900 dark:text-white">${pf.titulo}</p>
                                <p class="text-xs text-red-500 font-mono">-$${pf.monto.toLocaleString()}</p>
                            </div>
                        </div>
                        <button onclick="window.borrarPagoFijo('${pf.id}')" class="text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><i class="ph-bold ph-trash"></i></button>
                    </div>
                `);
            });
        }

        function renderizarCategorias() {
            const list = document.getElementById('eco-categories-list'); const select = document.getElementById('tx-category');
            list.innerHTML = ''; select.innerHTML = '<option value="General" selected>General</option>';
            estadoApp.categorias.forEach(cat => {
                list.insertAdjacentHTML('beforeend', `<span class="inline-flex items-center gap-1 px-3 py-1 bg-gray-50 dark:bg-gp-bg rounded-lg border border-gray-200 dark:border-zinc-800 text-sm group">${cat.nombre} <i onclick="window.borrarCategoria('${cat.id}')" class="ph-bold ph-x text-gray-400 hover:text-red-500 cursor-pointer ml-1"></i></span>`);
                select.insertAdjacentHTML('beforeend', `<option value="${cat.nombre}">${cat.nombre}</option>`);
            });
        }

        // --- ACCIONES DE FORMULARIOS ---
        document.getElementById('eco-quincena-form').addEventListener('submit', async (e) => {
            e.preventDefault(); const btn = document.getElementById('submit-q-config-btn'); btn.disabled = true;
            try { await setDoc(doc(db, `usuarios/${currentUser.uid}/configuraciones`, 'quincena'), { dia1: parseInt(document.getElementById('q-day1').value), dia2: document.getElementById('q-day2').value ? parseInt(document.getElementById('q-day2').value) : null }); mostrarNotificacion("Ciclo actualizado"); } catch (error) { alert("Error"); } finally { btn.disabled = false; }
        });

        document.getElementById('eco-account-form').addEventListener('submit', async (e) => {
            e.preventDefault(); const btn = document.getElementById('submit-acc-btn'); btn.disabled = true;
            try { await addDoc(collection(db, `usuarios/${currentUser.uid}/cuentas`), { nombre: document.getElementById('acc-name').value, tipo: document.getElementById('acc-type').value, saldo_inicial: parseFloat(document.getElementById('acc-balance').value), fecha_creacion: serverTimestamp() }); document.getElementById('eco-account-form').reset(); mostrarNotificacion("Bóveda creada"); } catch (error) { alert("Error."); } finally { btn.disabled = false; }
        });

        document.getElementById('eco-fixed-form').addEventListener('submit', async (e) => {
            e.preventDefault(); const btn = document.getElementById('submit-fixed-btn'); btn.disabled = true;
            try { await addDoc(collection(db, `usuarios/${currentUser.uid}/pagos_fijos`), { titulo: document.getElementById('fixed-title').value, monto: parseFloat(document.getElementById('fixed-amount').value), dia: parseInt(document.getElementById('fixed-day').value) }); document.getElementById('eco-fixed-form').reset(); mostrarNotificacion("Pago fijo guardado"); } catch (error) { alert("Error."); } finally { btn.disabled = false; }
        });

        document.getElementById('eco-tdc-form').addEventListener('submit', async (e) => {
            e.preventDefault(); const btn = document.getElementById('submit-tdc-config-btn'); btn.disabled = true;
            const cuentaSeleccionada = document.getElementById('tdc-config-account').value;
            const dataConfig = { cuenta: cuentaSeleccionada, limite: parseFloat(document.getElementById('tdc-config-limit').value), dia_corte: parseInt(document.getElementById('tdc-config-cutoff').value), dia_pago: parseInt(document.getElementById('tdc-config-payment').value) };
            try {
                const existe = estadoApp.tdcConfig.find(c => c.cuenta === cuentaSeleccionada);
                if (existe) await updateDoc(doc(db, `usuarios/${currentUser.uid}/tdc_config`, existe.id), dataConfig);
                else await addDoc(collection(db, `usuarios/${currentUser.uid}/tdc_config`), dataConfig);
                document.getElementById('eco-tdc-form').reset(); mostrarNotificacion("Configuración guardada");
            } catch (error) { alert("Error."); } finally { btn.disabled = false; }
        });

        document.getElementById('eco-category-form').addEventListener('submit', async (e) => {
            e.preventDefault(); const nameInput = document.getElementById('cat-name');
            try { await addDoc(collection(db, `usuarios/${currentUser.uid}/categorias`), { nombre: nameInput.value }); nameInput.value = ''; mostrarNotificacion("Etiqueta añadida"); } catch (error) { alert("Error."); }
        });

        const txForm = document.getElementById('transaction-form');
        txForm.addEventListener('submit', async (e) => {
            e.preventDefault(); const btn = document.getElementById('submit-tx-btn'); btn.disabled = true;
            const idEdicion = document.getElementById('tx-id-hidden').value; const dateInput = document.getElementById('tx-date').value;
            const linkedFixedId = document.getElementById('tx-fixed-id').value; const tipoTx = document.querySelector('input[name="tx_type"]:checked').value;
            
            const data = { 
                monto: parseFloat(document.getElementById('tx-amount').value), descripcion: document.getElementById('tx-desc').value, 
                cuenta: document.getElementById('tx-account').value, categoria: tipoTx === 'transferencia' ? 'Transferencia' : document.getElementById('tx-category').value, 
                tipo: tipoTx, ignoreDaily: document.getElementById('tx-ignore-daily').checked
            };
            if (tipoTx === 'transferencia') data.cuenta_destino = document.getElementById('tx-account-dest').value;
            if (dateInput) data.fecha = new Date(dateInput); else if (!idEdicion) data.fecha = serverTimestamp();
            
            try {
                if (idEdicion) { await updateDoc(doc(db, `usuarios/${currentUser.uid}/transacciones`, idEdicion), data); mostrarNotificacion("Actualizado"); cancelarEdicion(); } 
                else { 
                    await addDoc(collection(db, `usuarios/${currentUser.uid}/transacciones`), data); 
                    if (linkedFixedId) {
                        const hoy = new Date(); const currentYYYYMM = `${hoy.getFullYear()}-${String(hoy.getMonth()+1).padStart(2, '0')}`;
                        await updateDoc(doc(db, `usuarios/${currentUser.uid}/pagos_fijos`, linkedFixedId), { ultimo_pago: currentYYYYMM });
                        document.getElementById('tx-fixed-id').value = ''; 
                    }
                    mostrarNotificacion("Registrado"); 
                }
                txForm.reset(); document.querySelector('[data-target="view-dashboard"]').click();
            } catch (error) { alert("Error."); } finally { btn.disabled = false; }
        });

        // Lógica Pagar / Omitir (Llamadas desde Dashboard)
        window.prepararPagoFijo = (id) => {
            const pf = estadoApp.pagosFijos.find(p => p.id === id); if(!pf) return;
            document.getElementById('tx_type_gasto').checked = true; document.getElementById('tx_type_gasto').dispatchEvent(new Event('change'));
            document.getElementById('tx-amount').value = pf.monto; document.getElementById('tx-desc').value = `Pago: ${pf.titulo}`;
            document.getElementById('tx-ignore-daily').checked = true; document.getElementById('tx-fixed-id').value = pf.id; 
            mostrarNotificacion("Selecciona la cuenta origen"); document.querySelector('[data-target="view-payments"]').click();
        };

        window.omitirPagoFijo = async (id) => {
            if(confirm("¿Omitir este pago este mes? (Liberará el saldo en el presupuesto diario).")) {
                const hoy = new Date(); const currentYYYYMM = `${hoy.getFullYear()}-${String(hoy.getMonth()+1).padStart(2, '0')}`;
                await updateDoc(doc(db, `usuarios/${currentUser.uid}/pagos_fijos`, id), { ultimo_pago: currentYYYYMM }); mostrarNotificacion("Pago omitido");
            }
        };

        // --- MIGRACIÓN JSON ---
        document.getElementById('import-json-btn').addEventListener('click', () => { document.getElementById('import-json-input').click(); });
        document.getElementById('import-json-input').addEventListener('change', async (e) => {
            const file = e.target.files[0]; if (!file) return;
            const btn = document.getElementById('import-json-btn'); const originalText = btn.innerHTML;
            btn.innerHTML = `Procesando...`; btn.disabled = true;
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    let cuentaMigrada = estadoApp.cuentas.find(c => c.nombre === "Bóveda Anterior");
                    if (!cuentaMigrada && data.transactions && data.transactions.length > 0) await addDoc(collection(db, `usuarios/${currentUser.uid}/cuentas`), { nombre: "Bóveda Anterior", tipo: "Efectivo", saldo_inicial: 0, fecha_creacion: serverTimestamp() });
                    if (data.transactions && Array.isArray(data.transactions)) {
                        const cats = [...new Set(data.transactions.map(t => t.category).filter(Boolean))];
                        for (const cat of cats) { if (!estadoApp.categorias.find(c => c.nombre.toLowerCase() === cat.toLowerCase())) await addDoc(collection(db, `usuarios/${currentUser.uid}/categorias`), { nombre: cat }); }
                        for (let i = 0; i < data.transactions.length; i += 400) {
                            const batch = writeBatch(db);
                            data.transactions.slice(i, i + 400).forEach(tx => {
                                batch.set(doc(collection(db, `usuarios/${currentUser.uid}/transacciones`)), { 
                                    monto: Number(tx.amount)||0, descripcion: tx.title||"Migración", cuenta: "Bóveda Anterior", 
                                    categoria: tx.category||"General", tipo: tx.type==='income'?'ingreso':'gasto', 
                                    fecha: tx.createdAt ? new Date(tx.createdAt) : new Date((tx.date||'')+"T12:00:00"),
                                    ignoreDaily: tx.ignoreDaily || tx.ignoreBudget || false
                                });
                            });
                            await batch.commit();
                        }
                    }
                    if (data.fixed && Array.isArray(data.fixed)) {
                        const batchFijos = writeBatch(db);
                        data.fixed.forEach(fijo => batchFijos.set(doc(collection(db, `usuarios/${currentUser.uid}/pagos_fijos`)), { titulo: fijo.title||"Fijo", monto: Number(fijo.amount)||0, dia: Number(fijo.day)||1 }));
                        await batchFijos.commit();
                    }
                    mostrarNotificacion(`Importado exitosamente.`); e.target.value = '';
                } catch (error) { alert("Error: " + error.message); } finally { btn.innerHTML = originalText; btn.disabled = false; }
            }; reader.readAsText(file);
        });

        document.getElementById('export-csv-btn').addEventListener('click', () => {
            if(estadoApp.transacciones.length === 0) return alert("Sin datos.");
            let csv = "Fecha,Descripcion,Cuenta,Categoria,Tipo,Monto,IgnoradoPresupuesto\n";
            estadoApp.transacciones.forEach(tx => csv += `${tx.fecha ? tx.fecha.toDate().toISOString() : new Date().toISOString()},"${tx.descripcion}","${tx.cuenta}","${tx.categoria}",${tx.tipo},${tx.monto},${tx.ignoreDaily||false}\n`);
            const link = document.createElement("a"); link.setAttribute("href", URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' })));
            link.setAttribute("download", `godsplan_${Date.now()}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link);
        });

        // --- CRUD WINDOW ---
        window.borrarTx = async (id) => { if(confirm("¿Eliminar este registro?")) { await deleteDoc(doc(db, `usuarios/${currentUser.uid}/transacciones`, id)); mostrarNotificacion("Eliminado"); } };
        window.borrarCuenta = async (id) => { if(confirm("¿Eliminar bóveda?")) { await deleteDoc(doc(db, `usuarios/${currentUser.uid}/cuentas`, id)); mostrarNotificacion("Eliminada"); } };
        window.borrarPagoFijo = async (id) => { if(confirm("¿Eliminar pago fijo?")) { await deleteDoc(doc(db, `usuarios/${currentUser.uid}/pagos_fijos`, id)); mostrarNotificacion("Eliminado"); } };
        window.borrarCategoria = async (id) => { if(confirm("¿Eliminar esta etiqueta?")) await deleteDoc(doc(db, `usuarios/${currentUser.uid}/categorias`, id)); };
        
        window.ajustarCuenta = async (id, saldoActual, nombre) => {
            const saldoReal = parseFloat(prompt(`Saldo actual: $${saldoActual.toFixed(2)}\nDinero REAL:`));
            if (isNaN(saldoReal)) return; const dif = saldoReal - saldoActual; if (dif === 0) return;
            await addDoc(collection(db, `usuarios/${currentUser.uid}/transacciones`), { monto: dif, descripcion: 'Cuadre de caja', cuenta: nombre, categoria: 'Sistema', tipo: 'ajuste', fecha: serverTimestamp(), ignoreDaily: true });
        };
        window.editarTx = async (id) => {
            const docSnap = await getDoc(doc(db, `usuarios/${currentUser.uid}/transacciones`, id));
            if (docSnap.exists()) {
                const tx = docSnap.data(); document.getElementById('tx-id-hidden').value = id; document.getElementById('tx-amount').value = tx.monto; document.getElementById('tx-desc').value = tx.descripcion; document.getElementById('tx-account').value = tx.cuenta; document.getElementById('tx-category').value = tx.categoria; document.querySelector(`input[name="tx_type"][value="${tx.tipo}"]`).checked = true; document.querySelector(`input[name="tx_type"]:checked`).dispatchEvent(new Event('change'));
                if (tx.tipo === 'transferencia') document.getElementById('tx-account-dest').value = tx.cuenta_destino;
                document.getElementById('tx-ignore-daily').checked = tx.ignoreDaily || false;
                if(tx.fecha) { const d = tx.fecha.toDate(); document.getElementById('tx-date').value = (new Date(d - d.getTimezoneOffset() * 60000)).toISOString().slice(0, 16); }
                document.getElementById('tx-header-title').textContent = "Editar Operación"; document.getElementById('submit-tx-btn').textContent = "Actualizar"; document.getElementById('cancel-edit-btn').classList.remove('hidden'); document.querySelector('[data-target="view-payments"]').click();
            }
        };
        function cancelarEdicion() { document.getElementById('tx-id-hidden').value = ''; document.getElementById('tx-fixed-id').value = ''; document.getElementById('transaction-form').reset(); document.getElementById('tx-header-title').textContent = "Nueva Operación"; document.getElementById('submit-tx-btn').textContent = "Guardar Operación"; document.getElementById('cancel-edit-btn').classList.add('hidden'); document.getElementById('tx_type_gasto').dispatchEvent(new Event('change'));}
        document.getElementById('cancel-edit-btn').addEventListener('click', (e) => { e.preventDefault(); cancelarEdicion(); });

        // --- UI & MOBILE SIDEBAR ---
        document.getElementById('themeToggleBtn').addEventListener('click', () => { document.documentElement.classList.toggle('dark'); });
        document.getElementById('logout-btn').addEventListener('click', () => { signOut(auth); });
        
        const sidebar = document.getElementById('sidebar'); const sidebarBackdrop = document.getElementById('sidebar-backdrop');
        function toggleMobileSidebar() { sidebar.classList.toggle('-translate-x-full'); sidebarBackdrop.classList.toggle('hidden'); }
        document.getElementById('mobile-menu-btn').addEventListener('click', toggleMobileSidebar); document.getElementById('close-sidebar-btn').addEventListener('click', toggleMobileSidebar); sidebarBackdrop.addEventListener('click', toggleMobileSidebar);

        const navLinks = document.querySelectorAll('.nav-link'); const viewSections = document.querySelectorAll('.view-section');
        navLinks.forEach(link => {
            if(link.hasAttribute('data-target')) {
                link.addEventListener('click', () => {
                    if (window.innerWidth < 768 && !sidebar.classList.contains('-translate-x-full')) toggleMobileSidebar();
                    const targetId = link.getAttribute('data-target'); viewSections.forEach(s => s.classList.add('hidden')); document.getElementById(targetId).classList.remove('hidden');
                    navLinks.forEach(nav => { nav.classList.remove('bg-gray-100', 'dark:bg-zinc-800', 'text-blue-600', 'dark:text-white'); nav.classList.add('text-gray-500', 'dark:text-gp-muted'); });
                    link.classList.remove('text-gray-500', 'dark:text-gp-muted'); link.classList.add('bg-gray-100', 'dark:bg-zinc-800', 'text-blue-600', 'dark:text-white');
                });
            }
        });
    </script>
</body>
</html>
